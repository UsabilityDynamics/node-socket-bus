<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/websocket-mq.js - WebSocket MQ</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="WebSocket MQ"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/websocket-mq.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 *
 * ### Events
 * - connection
 * - connection.success
 * - connection.error
 *
 *
 * @type {*}
 */
function WebSocket( settings, cb ) {

  // Make sure context is correct otherwise we could screw up the global scope.
  if( !( this instanceof WebSocket ) ) {
    return new WebSocket( options, cb );
  }

  var Instance     = this;

  // Mixin Settings and EventEmitter
  require( &#x27;object-settings&#x27; ).mixin( Instance );
  require( &#x27;object-emitter&#x27; ).mixin( Instance );
  require( &#x27;object-emitter&#x27; ).inject( WebSocket.Server.prototype );

  // Configure instance.
  Instance.set({
    settings: settings,
    identity: String( process.pid ),
    retry: 100,
    max_retry: 5000
  });

  // Start WebSocket Server.
  Instance.Server = new WebSocket.Server({
    host: Instance.get( &#x27;settings.host&#x27;, &#x27;localhost&#x27; ),
    port: Instance.get( &#x27;settings.port&#x27;, 80123 ),
    path: Instance.get( &#x27;settings.port&#x27;, &#x27;/&#x27; )
  });

  // Handle Server Errors.
  Instance.Server.on( &#x27;error&#x27;, function error( error ) {

    switch( error.code ) {

      case &#x27;EACCES&#x27;: {
        Instance.Server.emit( &#x27;error.unable_to_bind&#x27;, new Error( &#x27;WebSocket can not bind.&#x27; ) );
      } break;

      case &#x27;EADDRINUSE&#x27;: {
        Instance.Server.emit( &#x27;error.address_in_use&#x27;, new Error( &#x27;WebSocket port already used.&#x27; ) );
      } break;

    }

  });

  // Handle new Connections
  Instance.Server.on( &#x27;connection&#x27;, function connection( socket ) {

    // Set Unique SessionID
    socket.session = {
      key: socket.upgradeReq.headers[ &#x27;sec-websocket-key&#x27; ],
      sid: Math.random().toString( 36 ).substring( 2 ),
      headers: socket.upgradeReq.headers,
      method: socket.upgradeReq.method,
      path: socket.upgradeReq.url
    }

    socket.send( &#x27;{&quot;event&quot;:&quot;handshake&quot;,&quot;sid&quot;:&quot;&#x27; + socket.session.sid + &#x27;&quot;}&#x27; );

    // Handle Incoming Messages.
    socket.on( &#x27;message&#x27;, function incoming( message ) {

      // Parse to JSON
      if( message instanceof Buffer ) {
        message = msgpack.unpack( options.buffer )
      }

      // Add properties.
      WebSocket.utility.extend( message, {
        id: socket.session.id,
        session: socket.session,
        event: &#x27;string&#x27; === typeof message ? message : message.event,
        data: message
      });

      // Expose.
      // Instance.emit( &#x27;server.message&#x27;, null, message );

    });

  });

  // Server Bound.
  Instance.Server.on( &#x27;listening&#x27;, function listening() {

    // Update / Verify Settings.
    Instance.set( &#x27;settings&#x27;, {
      host: this._server.address().address,
      port: this._server.address().port
    });

    if( &#x27;function&#x27; === typeof cb ) {
      cb( null, this );
    }

  });

  // Merge Server events into instance.
  WebSocket.utility.extend( Instance._events, Instance.Server._events );

  // Return server instance.
  return Instance;

}

/**
 * WebSocket MQ Server Properties.
 *
 */
Object.defineProperties( WebSocket.prototype, {
  configure: {
    /**
     * Configure Client
     *
     * Method executed when connection is ready.
     * Usage and semantics emulating Express.
     *
     * @param env
     * @param fn
     * @returns {*}
     */
    value: function configure( env, fn ) {
      var envs      = &#x27;all&#x27;;
      var args      = [].slice.call(arguments);

      fn = args.pop();

      if( args.length ) {
        envs = args;
      }

      if( &#x27;all&#x27; == envs || ~envs.indexOf( this.get( &#x27;environment&#x27; ) ) ) {
        this.on( &#x27;connection.success&#x27;, fn.bind( this, this ) );
      }

      return this;

    },
    enumerable: true,
    writable: true,
    configurable: true
  },
  getQueue: {
    value: function getQueue() {},
    enumerable: true,
    configurable: true,
    writable: true
  },
  createBroker: {
    value: function getQueue() {},
    enumerable: true,
    configurable: true,
    writable: true
  },
  subscribe: {
    value: function getQueue() {},
    enumerable: true,
    configurable: true,
    writable: true
  },
  send: {
    value: function getQueue() {},
    enumerable: true,
    configurable: true,
    writable: true
  }
})

/**
 * WebSocket MQ Constructor Properties.
 *
 */
Object.defineProperties( module.exports = WebSocket, {
  Server: {
    value: require( &#x27;ws&#x27; ).Server,
    enumerable: false,
    writable: true,
    configurable: true
  },
  amqp: {
    value: require( &#x27;amqp&#x27; ),
    enumerable: false,
    writable: true,
    configurable: true
  },
  debug: {
    value: require( &#x27;debug&#x27; )( &#x27;websocket-mq&#x27; ),
    enumerable: false,
    configurable: true,
    writable: true
  },
  utility: {
    value: require( &#x27;./utility&#x27; ),
    enumerable: false,
    configurable: true,
    writable: true
  },
  createServer: {
    value: function createServer( options, cb ) {
      return new WebSocket( options, cb );
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  createProxy: {
    value: function createProxy( options, cb ) {
      return new WebSocket( options, cb );
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  createConnection: {
    value: function createConnection( options, cb ) {

      if (!(this instanceof createConnection)) {
        return new createConnection( options, cb );
      }

      var Instance     = this;
      var validation   = require( &#x27;object-validation&#x27; );
      var msgpack      = require( &#x27;msgpack&#x27; );
      var ws           = require( &#x27;ws&#x27; );
      var extend       = require( &#x27;extend&#x27; );

      // Mixin Settings and EventEmitter
      require( &#x27;object-settings&#x27; ).mixin( this );
      require( &#x27;object-emitter&#x27; ).mixin( this );
      require( &#x27;object-emitter&#x27; ).inject( ws.prototype );

      options = WebSocket.utility.extend({
        host: &#x27;localhost&#x27;,
        port: 92000,
        origin: options.origin,
        passphrase: null,
        pfx: null,
        key: null,
        cert: null,
        ca: null,
      }, options )

      // Create Client Instance.
      Instance.Client = new ws.createConnection( &#x27;http://&#x27; + options.host + &#x27;:&#x27; + options.port, {
        origin: options.origin || options.host,
        passphrase: options.passphrase,
        pfx: options.pfx,
        key: options.key
      });

      Instance.Client.on( &#x27;open&#x27;, function open() {
        // Instance.emit( &#x27;open&#x27;, null );
      });

      // Handle Client Errors.
      Instance.Client.on( &#x27;error&#x27;, function error( error ) {

        switch( error.code ) {

          case &#x27;ECONNREFUSED&#x27;: {
            Instance.emit( &#x27;error.connection_refused&#x27;, new Error( &#x27;ServiceBus client could not connect to server.&#x27; ), this );
          } break;

        }

        // Expose general error.
        // Instance.emit( &#x27;error&#x27;, error, this );

      });

      // Message from DSB
      Instance.Client.on( &#x27;message&#x27;, function message( message, options, buffer ) {

        if( message instanceof Buffer ) {
          // message = msgpack.unpack( options.buffer )
        }

        if( &#x27;string&#x27; === typeof message ) {
          message = { event: message }
        }

        // Emit to Root EventEmitter
        // Instance.emit( &#x27;message&#x27;, null, message );

      });

      // Merge Server events into instance.
      WebSocket.utility.extend( Instance._events, Instance.Client._events );

      // Return client instance.
      return this;

    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  createClient: {
    value: function() {
      return WebSocket.createConnection;
    },
    enumerable: false,
    configurable: true
  }
})


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
